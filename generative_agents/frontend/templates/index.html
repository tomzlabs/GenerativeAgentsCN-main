{% extends "base.html" %}

{% block content %}
<div class="page">
    <header class="hero">
        <div class="hero-text">
            <p class="hero-eyebrow">Reverie · 生成式智能体小镇</p>
            <h1>小镇回放控制台</h1>
            <p class="hero-subtitle">浏览智能体的活动轨迹、对话与当前位置。选择居民查看状态，按方向键移动视角。</p>
        </div>
        <div class="hero-meta">
            <span class="meta-pill">方向键移动视角</span>
            <span class="meta-pill">滚轮缩放视图</span>
            <span class="meta-pill">空格键暂停/继续</span>
        </div>
    </header>

    <main class="layout">
        <section class="canvas-panel">
            <div class="canvas-shell">
                <div id="game-container"></div>
                <div class="canvas-overlay">
                    <div class="overlay-card">
                        <div class="overlay-title">提示</div>
                        <div class="overlay-text">点击居民头像查看实时描述与目标位置。</div>
                    </div>
                </div>
            </div>
        </section>

        <aside class="side-panel">
            <div class="card agent-card">
                <div class="card-title">居民</div>
                <div class="agent-grid">
                    {% for p in persona_names %}
                    <div class="agent-chip" id="on_screen_det_trigger_container-{{ p }}">
                        <a class="agent-link" href="javascript:void(0);" id="on_screen_det_trigger-{{ p }}">
                            {% set image_static = 'assets/village/agents/' ~ p ~ '/portrait.png' %}
                            <img src="{{ url_for('static', filename=image_static) }}" class="agent-avatar" alt="{{ p }}">
                            <span class="agent-name">{{ p }}</span>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="card detail-card">
                <div class="card-title">当前状态</div>
                <div class="detail-placeholder" id="on_screen_det_content-init">
                    点击角色可查看更多细节。
                </div>

                {% for p in persona_names %}
                    <div class="detail-content" id="on_screen_det_content-{{ p }}" style="display: none;">
                        <div class="detail-avatar">
                            {% set image_static = 'assets/village/agents/' ~ p ~ '/portrait.png' %}
                            <img src="{{ url_for('static', filename=image_static) }}" alt="{{ p }}">
                        </div>
                        <div class="detail-body">
                            <p class="detail-desc"><span id="agent_desc__{{ p }}"></span></p>
                            <p class="detail-action">当前活动：<span id="current_action__{{ p }}"></span></p>
                            <p class="detail-location">目标位置：<span id="target_address__{{ p }}"></span></p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </aside>
    </main>
</div>

<div class="sr-only" id="temp_focus"></div>

{% endblock content %}

{% block js_content %}
<script src='https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js'></script>
{% include 'main_script.html' %}
<script>
{% for p in persona_names %}
    $('#on_screen_det_trigger-{{ p }}').click(function() {
        $('#on_screen_det_content-init').css({
          'display': 'none',
        });
        {% for p_i in persona_names %}
            $('#on_screen_det_content-{{p_i}}').css({
                'display': 'none',
            });
            $('#on_screen_det_trigger-{{p_i}}').css({
                'font-weight': '500',
            });
            $('#on_screen_det_trigger_container-{{p_i}}').css({
                'background-color': 'white',
                'border-radius': '10px'
            });
        {% endfor %}

        $('#on_screen_det_trigger-{{ p }}').css({
            'font-weight': '900',
        });
        $('#on_screen_det_trigger_container-{{ p }}').css({
            'background-color': '#ABFF84',
            'border-radius': '10px'
        });
        $('#on_screen_det_content-{{ p }}').css({
            'display': 'block',
        });

        document.getElementById("temp_focus").innerHTML = "{{ p }}";
    });
{% endfor %}
</script>
{% endblock js_content %}
