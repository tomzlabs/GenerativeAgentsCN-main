{% extends "base.html" %}

{% block content %}
<div class="page">
    <header class="hero">
        <div class="hero-text">
            <p class="hero-eyebrow">SYSTEM: ONLINE | SIMULATION: ACTIVE</p>
            <h1>AI 小镇 <span
                    style="font-size: 12px; color: #ff0055; vertical-align: middle; animation: blink 1s infinite;">●
                    LIVE</span></h1>
            <p class="hero-subtitle">浏览智能体的活动轨迹、对话与当前位置。选择居民查看状态，按方向键移动视角。</p>
        </div>
        <div class="hero-meta">
            <span class="meta-pill">方向键移动视角</span>
            <span class="meta-pill">滚轮缩放视图</span>
            <span class="meta-pill">空格键暂停/继续</span>
            <button id="connect-bot-btn" class="meta-pill"
                style="cursor: pointer; background: var(--accent); color: #000;">⚡ 接入 BOT</button>
        </div>
    </header>

    <section class="agent-bar">
        <div class="card agent-card">
            <div class="card-title">居民 (点击查看详情 / 接入 BOT)</div>
            <div class="agent-grid">
                {% for p in persona_names %}
                <div class="agent-chip" id="on_screen_det_trigger_container-{{ p }}">
                    <a class="agent-link" href="javascript:void(0);" id="on_screen_det_trigger-{{ p }}">
                        {% set image_static = 'assets/village/agents/' ~ persona_path_map[p] ~ '/portrait.png' %}
                        <img src="{{ url_for('static', filename=image_static) }}" class="agent-avatar" alt="{{ p }}">
                        <span class="agent-name">{{ p }}</span>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <main class="layout-stack">
        <section class="canvas-panel">
            <div class="canvas-shell">
                <div id="loading-screen">
                    <div id="loading-text">INITIALIZING SYSTEM...</div>
                    <div class="loading-bar">
                        <div class="loading-progress" id="progress-bar"></div>
                    </div>
                </div>
                <div id="game-container"></div>
                <div class="canvas-overlay">
                    <div class="overlay-card">
                        <div class="overlay-title">提示</div>
                        <div class="overlay-text">点击居民头像查看实时描述与目标位置。</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="detail-panel">
            <div class="card detail-card">
                <div class="card-title">当前状态</div>
                <div class="detail-placeholder" id="on_screen_det_content-init">
                    点击角色可查看更多细节。
                </div>

                {% for p in persona_names %}
                <div class="detail-content" id="on_screen_det_content-{{ p }}" style="display: none;">
                    <div class="detail-avatar">
                        {% set image_static = 'assets/village/agents/' ~ persona_path_map[p] ~ '/portrait.png' %}
                        <img src="{{ url_for('static', filename=image_static) }}" alt="{{ p }}">
                    </div>
                    <div class="detail-body">
                        <p class="detail-desc"><span id="agent_desc__{{ p }}"></span></p>
                        <p class="detail-action">当前活动：<span id="current_action__{{ p }}"></span></p>
                        <p class="detail-location">目标位置：<span id="target_address__{{ p }}"></span></p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
    </main>
</div>

<div class="sr-only" id="temp_focus"></div>

<!-- Connect Bot Modal -->
<div id="connect-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 style="font-family: var(--font-header); color: var(--accent); margin-top: 0;">⚡ 接入外部 BOT</h2>
        <p>选择一个居民并输入你的 Bot API 地址。</p>

        <div class="form-group">
            <label>选择居民:</label>
            <select id="bot-agent-select">
                {% for p in persona_names %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>API 地址:</label>
            <input type="text" id="bot-api-url" placeholder="http://localhost:5000/api"
                value="http://localhost:5000/api">
        </div>

        <button id="confirm-connect-btn" class="pixel-btn">开始连接</button>
        <div id="connect-status" style="margin-top: 10px; font-size: 12px;"></div>
    </div>
</div>

{% endblock content %}

{% block js_content %}
<script src='https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js'></script>
{% include 'main_script.html' %}
<script>
    {% for p in persona_names %}
    $('#on_screen_det_trigger-{{ p }}').click(function () {
        $('#on_screen_det_content-init').css({
            'display': 'none',
        });
        {% for p_i in persona_names %}
        $('#on_screen_det_content-{{p_i}}').css({
            'display': 'none',
        });
        $('#on_screen_det_trigger-{{p_i}}').css({
            'font-weight': '500',
        });
        $('#on_screen_det_trigger_container-{{p_i}}').css({
            'background-color': 'white',
            'border-radius': '10px'
        });
        {% endfor %}

        $('#on_screen_det_trigger-{{ p }}').css({
            'font-weight': '900',
        });
        $('#on_screen_det_trigger_container-{{ p }}').css({
            'background-color': '#ABFF84',
            'border-radius': '10px'
        });
        $('#on_screen_det_content-{{ p }}').css({
            'display': 'block',
        });

        document.getElementById("temp_focus").innerHTML = "{{ p }}";
    });
    {% endfor %}

    // Connect Bot Modal Logic
    var modal = document.getElementById("connect-modal");
    var btn = document.getElementById("connect-bot-btn");
    var span = document.getElementsByClassName("close-modal")[0];

    btn.onclick = function () {
        modal.style.display = "flex";
    }

    span.onclick = function () {
        modal.style.display = "none";
    }

    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    document.getElementById("confirm-connect-btn").addEventListener("click", function () {
        let agentName = document.getElementById("bot-agent-select").value;
        let apiUrl = document.getElementById("bot-api-url").value;
        let statusDiv = document.getElementById("connect-status");

        statusDiv.innerText = "Connecting...";

        fetch("/api/connect_agent", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                "agent_name": agentName,
                "api_url": apiUrl
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    statusDiv.innerText = "Success: " + data.message;
                    statusDiv.style.color = "#00ff00";
                    setTimeout(() => { modal.style.display = "none"; }, 1500);
                } else {
                    statusDiv.innerText = "Error: " + data.message;
                    statusDiv.style.color = "#ff0055";
                }
            })
            .catch(error => {
                statusDiv.innerText = "Error: " + error;
                statusDiv.style.color = "#ff0055";
            });
    });
</script>
{% endblock js_content %}